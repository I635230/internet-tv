# SQL

6つの課題に対してのQueryを記載しています。

本Queryは2023/11/08にQueryを実行していています。
アウトプットを比較したい場合は、適宜`CURDATE()`を'2023-11-08'に書き換えてください。

## Query1

よく見られているエピソードを知りたいです。

エピソード視聴数トップ3のエピソードタイトルと視聴数を取得してください

### input

```sql
SELECT t2.title AS エピソードタイトル, 
t2.views AS 視聴数
FROM tv_shows AS t1 INNER
JOIN episodes AS t2 ON t1.id = t2.tv_show_id
ORDER BY views desc limit 3;
```

### output

```
+-----------------------------------------------------------+-----------+
| エピソードタイトル                                        | 視聴数    |
+-----------------------------------------------------------+-----------+
| シーズン1エピソード22 - 愛と宗介の結婚式                  |   3250000 |
| シーズン2エピソード12 - 闘いの結末                        |   3200000 |
| シーズン1エピソード22 - 鬼の襲撃                          |   3100000 |
+-----------------------------------------------------------+-----------+
```

## Query2

よく見られているエピソードの番組情報やシーズン情報も合わせて知りたいです。

エピソード視聴数トップ3の番組タイトル、シーズン数、エピソード数、エピソードタイトル、視聴数を取得してください

### input

```sql
SELECT
t1.title AS 番組タイトル, 
t2.season AS シーズン数, 
t2.chapter AS エピソード数, 
t2.title AS エピソードタイトル, 
t2.views AS 視聴数
FROM tv_shows AS t1 INNER
JOIN episodes AS t2 ON t1.id = t2.tv_show_id
ORDER BY views DESC LIMIT 3;
```

### output

```
+-----------------------------+-----------------+--------------------+-----------------------------------------------------------+-----------+
| 番組タイトル                | シーズン数      | エピソード数       | エピソードタイトル                                        | 視聴数    |
+-----------------------------+-----------------+--------------------+-----------------------------------------------------------+-----------+
| 彼女はキレイだった          |               1 |                 22 | シーズン1エピソード22 - 愛と宗介の結婚式                  |   3250000 |
| 半沢直樹                    |               2 |                 12 | シーズン2エピソード12 - 闘いの結末                        |   3200000 |
| 進撃の巨人                  |               1 |                 22 | シーズン1エピソード22 - 鬼の襲撃                          |   3100000 |
+-----------------------------+-----------------+--------------------+-----------------------------------------------------------+-----------+
```

## Query3

本日の番組表を表示するために、本日、どのチャンネルの、何時から、何の番組が放送されるのかを知りたいです。

本日放送される全ての番組に対して、チャンネル名、放送開始時刻(日付+時間)、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細を取得してください。

なお、番組の開始時刻が本日のものを本日方法される番組とみなすものとします

### input

```sql
SELECT 
t1.channel AS チャンネル名, 
CONCAT(t1.date, " ", t2.start) AS 放送開始時刻, 
t2.end AS 放送終了時刻, 
t3.season AS シーズン数, 
t3.chapter AS エピソード数, 
t3.title AS エピソードタイトル, 
t3.detail AS エピソード詳細
FROM programs AS t1 INNER
JOIN time_zones AS t2 ON t1.time_zone_id = t2.id
JOIN episodes AS t3 ON t1.episode_id = t3.id
WHERE t1.date = CURDATE()
ORDER BY t1.date, t2.start;
```

### output

```
+--------------------+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| チャンネル名       | 放送開始時刻        | 放送終了時刻       | シーズン数      | エピソード数       | エピソードタイトル                                             | エピソード詳細                                                                                                                                                                                                                                   |
+--------------------+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| アニメ             | 2023-11-08 00:00:00 | 00:30:00           |               3 |                  6 | シーズン3エピソード6 - 真実の扉                                | エドワードとアルフォンスは真実の扉に迫り、新たな知識を得る。扉との対決、錬金術の謎が解き明かされていく。                                                                                                                                         |
| アニメ             | 2023-11-08 01:30:00 | 02:00:00           |               4 |                  1 | シーズン4エピソード1 - 再出発                                  | ルフィと仲間たちは新たな冒険に向かう。新たな島、新たな敵との対決、仲間たちの成長が描かれる。                                                                                                                                                     |
| アニメ             | 2023-11-08 07:00:00 | 07:30:00           |               3 |                  2 | シーズン3エピソード2 - 鬼殺隊訓練                              | 炭治郎と仲間たちは鬼殺隊の訓練に挑む。厳しい修行、新たな鬼の襲撃が待ち受ける。鬼殺隊の力が試される。                                                                                                                                             |
| ドラマ             | 2023-11-08 09:30:00 | 10:00:00           |               1 |                  5 | シーズン1エピソード5 - #5 新しい生活の始まり                   | シーズン1エピソード5 - #5 新しい生活の始まり                                                                                                                                                                                                     |
| アニメ             | 2023-11-08 10:30:00 | 11:00:00           |               1 |                 26 | シーズン1エピソード26 - 最終決戦                               | 炭治郎と鬼殺隊は無惨との最終決戦に挑む。無惨の圧倒的な力に立ち向かい、仲間たちとの絆を深めながら戦闘が繰り広げられる。                                                                                                                           |
| アニメ             | 2023-11-08 12:00:00 | 12:30:00           |               1 |                  1 | シーズン1エピソード1 - 鬼の襲来                                | 大正時代。竈門炭治郎の家族は鬼に襲われ、彼一人だけが生き残る。彼の妹禰豆子も鬼になってしまった。炭治郎の鬼殺隊入隊と、鬼の元凶である鬼舞辻無惨との戦いが始まる。                                                                                 |
| アニメ             | 2023-11-08 14:30:00 | 15:00:00           |               2 |                  2 | シーズン2エピソード2 - 海賊の秘宝                              | ルフィと仲間たちは海賊の秘宝を求め、新たな冒険に挑む。悪党たちや海軍との戦闘、伝説の宝物の謎を解き明かすために新たな仲間と出会う。                                                                                                               |
| ドラマ             | 2023-11-08 14:30:00 | 15:00:00           |               1 |                 15 | シーズン1エピソード15 - 情熱と別れの日                         | 愛と宗介の関係に決定的な出来事が訪れる感動のエピソード。                                                                                                                                                                                         |
| アニメ             | 2023-11-08 17:30:00 | 18:00:00           |               4 |                  6 | シーズン4エピソード6 - 海賊の秘宝                              | ルフィと仲間たちは海賊の秘宝を探し求め、新たな冒険が続く。秘密の宝物、敵の脅威との戦いが待ち受ける。                                                                                                                                             |
| ドラマ             | 2023-11-08 22:00:00 | 22:30:00           |               2 |                  1 | シーズン2エピソード1 - 新たな始まり                            | シーズン2エピソード1 - 新たな始まり                                                                                                                                                                                                              |
| ドラマ             | 2023-11-08 22:30:00 | 23:00:00           |               2 |                 15 | シーズン2エピソード15 - 愛の秘密                               | 愛の過去に関する秘密が明らかになるエピソード。                                                                                                                                                                                                   |
| ドラマ             | 2023-11-08 23:00:00 | 23:30:00           |               2 |                 11 | シーズン2エピソード11 - 愛の選択                               | 愛と宗介の未来を左右する選択を迫られるエピソード。                                                                                                                                                                                               |
| ドラマ             | 2023-11-08 23:30:00 | 00:00:00           |               2 |                  3 | シーズン2エピソード3 - 恋の秘密                                | 愛の過去に関する秘密が明らかになるエピソード。                                                                                                                                                                                                   |
+--------------------+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
```

## Query4

ドラマというチャンネルがあったとして、ドラマのチャンネルの番組表を表示するために、本日から一週間分、何日の何時から何の番組が放送されるのかを知りたいです。

ドラマのチャンネルに対して、放送開始時刻、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細を本日から一週間分取得してください

### input

```sql
SELECT 
CONCAT(t1.date, " ", t2.start) AS 放送開始時刻, 
t2.end AS 放送終了時刻, 
t3.season AS シーズン数, 
t3.chapter AS エピソード数, 
t3.title AS エピソードタイトル, 
t3.detail AS エピソード詳細
FROM programs AS t1 INNER
JOIN time_zones AS t2 ON t1.time_zone_id = t2.id INNER
JOIN episodes AS t3 ON t1.episode_id = t3.id
WHERE t1.channel = 'ドラマ'
AND t1.date BETWEEN CURDATE() AND CURDATE() + INTERVAL 6 DAY
ORDER BY t1.date, t2.start;
```

### output

```
+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+---------------------------------------------------------------------------------------+
| 放送開始時刻        | 放送終了時刻       | シーズン数      | エピソード数       | エピソードタイトル                                             | エピソード詳細                                                                        |
+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+---------------------------------------------------------------------------------------+
| 2023-11-08 09:30:00 | 10:00:00           |               1 |                  5 | シーズン1エピソード5 - #5 新しい生活の始まり                   | シーズン1エピソード5 - #5 新しい生活の始まり                                          |
| 2023-11-08 14:30:00 | 15:00:00           |               1 |                 15 | シーズン1エピソード15 - 情熱と別れの日                         | 愛と宗介の関係に決定的な出来事が訪れる感動のエピソード。                              |
| 2023-11-08 22:00:00 | 22:30:00           |               2 |                  1 | シーズン2エピソード1 - 新たな始まり                            | シーズン2エピソード1 - 新たな始まり                                                   |
| 2023-11-08 22:30:00 | 23:00:00           |               2 |                 15 | シーズン2エピソード15 - 愛の秘密                               | 愛の過去に関する秘密が明らかになるエピソード。                                        |
| 2023-11-08 23:00:00 | 23:30:00           |               2 |                 11 | シーズン2エピソード11 - 愛の選択                               | 愛と宗介の未来を左右する選択を迫られるエピソード。                                    |
| 2023-11-08 23:30:00 | 00:00:00           |               2 |                  3 | シーズン2エピソード3 - 恋の秘密                                | 愛の過去に関する秘密が明らかになるエピソード。                                        |
| 2023-11-09 02:00:00 | 02:30:00           |               2 |                  7 | シーズン2エピソード7 - 恋の秘密が明らかに                      | シーズン2エピソード7 - 恋の秘密が明らかに                                             |
| 2023-11-09 04:00:00 | 04:30:00           |               1 |                 19 | シーズン1エピソード19 - 企業の裏切り                           | 半沢直樹が企業の陰謀に立ち向かうエピソード。                                          |
| 2023-11-09 04:30:00 | 05:00:00           |               1 |                 15 | シーズン1エピソード16 - 敵の策略                               | 半沢直樹が敵の策略に立ち向かうエピソード。                                            |
| 2023-11-09 05:00:00 | 05:30:00           |               1 |                 16 | シーズン1エピソード16 - 人間ドラマ                             | 半沢直樹が人間ドラマに巻き込まれるエピソード。                                        |
| 2023-11-09 06:00:00 | 06:30:00           |               1 |                  9 | シーズン1エピソード9 - 敵の策略                                | 半沢直樹が敵の策略に立ち向かうエピソード。                                            |
| 2023-11-09 07:30:00 | 08:00:00           |               2 |                  5 | シーズン2エピソード5 - 愛の新たな仕事                          | 愛が新たな仕事に取り組むエピソード。                                                  |
| 2023-11-10 02:30:00 | 03:00:00           |               2 |                  6 | シーズン2エピソード6 - 学園の危機                              | ごくせんの学園に危機が迫る緊迫のエピソード。                                          |
| 2023-11-10 03:00:00 | 03:30:00           |               2 |                 16 | シーズン2エピソード16 - 教育の改革                             | ごくせんの学園で教育の改革が進むエピソード。                                          |
| 2023-11-10 03:30:00 | 04:00:00           |               2 |                  7 | シーズン2エピソード7 - 学園の危機                              | ごくせんの学園に危機が迫る緊迫のエピソード。                                          |
| 2023-11-10 04:00:00 | 04:30:00           |               2 |                 10 | シーズン2エピソード10 - HEROの決断                             | HEROが難題に立ち向かうエピソード。                                                    |
| 2023-11-10 05:30:00 | 06:00:00           |               1 |                 23 | シーズン1エピソード23 - 学園の危機                             | ごくせんの学園に危機が迫る緊迫のエピソード。                                          |
| 2023-11-10 10:30:00 | 11:00:00           |               2 |                 18 | シーズン2エピソード18 - 人間ドラマ                             | 半沢直樹が人間ドラマに巻き込まれるエピソード。                                        |
| 2023-11-11 08:00:00 | 08:30:00           |               2 |                 19 | シーズン2エピソード19 - 犯罪の闘い                             | HEROが新たな犯罪に立ち向かうエキサイティングなエピソード。                            |
| 2023-11-11 11:00:00 | 11:30:00           |               2 |                 12 | シーズン2エピソード12 - 闘いの結末                             | 半沢直樹が最終決戦に挑むエキサイティングなエピソード。                                |
| 2023-11-11 13:00:00 | 13:30:00           |               1 |                  6 | シーズン1エピソード6 - 学園の秘密                              | ごくせんの学園に秘密が明らかになるエピソード。                                        |
| 2023-11-11 15:30:00 | 16:00:00           |               1 |                 17 | シーズン1エピソード17 - HEROの新たな敵                         | HEROが新たな敵との闘いに挑むエピソード。                                              |
| 2023-11-11 16:30:00 | 17:00:00           |               1 |                 12 | シーズン1エピソード10 - HEROの決断                             | HEROが難題に立ち向かうエピソード。                                                    |
| 2023-11-11 17:00:00 | 17:30:00           |               1 |                 14 | シーズン1エピソード14 - HEROの新たな敵                         | HEROが新たな敵との闘いに挑むエピソード。                                              |
| 2023-11-12 03:00:00 | 03:30:00           |               2 |                 14 | シーズン2エピソード14 - 愛の決断                               | 愛と宗介の未来を左右する決断を迫られるエピソード。                                    |
| 2023-11-12 03:30:00 | 04:00:00           |               1 |                  8 | シーズン1エピソード8 - 裏切りと復讐                            | 半沢直樹が敵との対決に臨むエピソード。                                                |
| 2023-11-12 07:00:00 | 07:30:00           |               2 |                  2 | シーズン2エピソード2 - 新たな始まり                            | シーズン2エピソード2 - 新たな始まり                                                   |
| 2023-11-12 07:30:00 | 08:00:00           |               2 |                  4 | シーズン2エピソード4 - 愛の苦悩                                | 愛が苦悩するエキサイティングなエピソード。                                            |
| 2023-11-13 17:30:00 | 18:00:00           |               1 |                  3 | シーズン1エピソード3 - 恋の始まり                              | シーズン1エピソード3 - 恋の始まり                                                     |
| 2023-11-13 19:30:00 | 20:00:00           |               2 |                 14 | シーズン2エピソード14 - 愛と宗介の選択                         | 愛と宗介の未来を左右する選択を迫られるエピソード。                                    |
| 2023-11-13 20:30:00 | 21:00:00           |               1 |                 14 | シーズン1エピソード14 - 愛と宗介の関係                         | 愛と宗介の関係に新たな展開が訪れる感動のエピソード。                                  |
| 2023-11-13 21:00:00 | 21:30:00           |               1 |                 22 | シーズン1エピソード22 - 愛と宗介の結婚式                       | 愛と宗介の結婚が迫る感動のエピソード。                                                |
| 2023-11-13 21:30:00 | 22:00:00           |               1 |                 11 | シーズン1エピソード11 - 愛の選択                               | 愛と宗介の未来を左右する選択を迫られるエピソード。                                    |
| 2023-11-14 02:00:00 | 02:30:00           |               1 |                  4 | シーズン1エピソード4 - 学園の秘密                              | ごくせんの学園に秘密が明らかになるエピソード。                                        |
| 2023-11-14 09:00:00 | 09:30:00           |               2 |                 23 | シーズン2エピソード23 - 最終章                                 | 半沢直樹の物語が最終章へ向かうエピソード。                                            |
| 2023-11-14 11:00:00 | 11:30:00           |               2 |                 20 | シーズン2エピソード20 - 最終決戦                               | 半沢直樹が最終決戦に挑むエキサイティングなエピソード。                                |
| 2023-11-14 12:00:00 | 12:30:00           |               2 |                  5 | シーズン2エピソード5 - 企業の裏切り                            | 半沢直樹が企業の陰謀に立ち向かうエピソード。                                          |
+---------------------+--------------------+-----------------+--------------------+----------------------------------------------------------------+---------------------------------------------------------------------------------------+
```

## Query5

(advanced) 直近一週間で最も見られた番組が知りたいです。

直近一週間に放送された番組の中で、エピソード視聴数合計トップ2の番組に対して、番組タイトル、視聴数を取得してください

### input

```sql
SELECT t3.title AS 番組タイトル, 
SUM(views) AS 1週間の合計視聴数
FROM programs AS t1
INNER JOIN episodes AS t2 ON t1.episode_id = t2.id
INNER JOIN tv_shows AS t3 ON t2.tv_show_id = t3.id
WHERE t1.date BETWEEN CURDATE() - INTERVAL 6 DAY AND CURDATE()
GROUP BY t3.title
ORDER BY SUM(views) DESC LIMIT 2;
```

### output

```
+--------------------+---------------------------+
| 番組タイトル       | 1週間の合計視聴数         |
+--------------------+---------------------------+
| ワンピース         |                  15400000 |
| 鬼滅の刃           |                  11600000 |
+--------------------+---------------------------+
```

## Query6

(advanced) ジャンルごとの番組の視聴数ランキングを知りたいです。番組の視聴数ランキングはエピソードの平均視聴数ランキングとします。ジャンルごとに視聴数トップの番組に対して、ジャンル名、番組タイトル、エピソード平均視聴数を取得してください。

### input1 (相関サブクエリ使用)

```sql
WITH table1 AS 
(SELECT 
t4.category AS category, 
t3.title AS title, 
ROUND(AVG(views)) AS avg_views
FROM programs AS t1
INNER JOIN episodes AS t2 ON t1.episode_id = t2.id
INNER JOIN tv_shows AS t3 ON t2.tv_show_id = t3.id
INNER JOIN tv_show_categories AS t4 ON t3.title = t4.title
GROUP BY t3.title, t4.category
ORDER BY ROUND(AVG(views)) DESC)

SELECT 
t11.category AS カテゴリー, 
t11.title AS 番組タイトル, 
t11.avg_views AS エピソード平均視聴数
FROM table1 AS t11
WHERE t11.avg_views = (
	SELECT MAX(t12.avg_views)
	FROM table1 AS t12
	WHERE t11.category = t12.category);
```

### input2 (相関サブクエリ未使用)

```sql
WITH table1 AS 
(SELECT 
t4.category AS category, 
t3.title AS title, 
ROUND(AVG(views)) AS avg_views
FROM programs AS t1
INNER JOIN episodes AS t2 ON t1.episode_id = t2.id
INNER JOIN tv_shows AS t3 ON t2.tv_show_id = t3.id
INNER JOIN tv_show_categories AS t4 ON t3.title = t4.title
GROUP BY t3.title, t4.category
ORDER BY ROUND(AVG(views)) DESC), 

table2 AS
(SELECT category, MAX(avg_views) AS max_views
FROM table1
GROUP BY category)

SELECT t12.category AS カテゴリー, 
t11.title AS 番組タイトル, 
t12.max_views AS エピソード平均視聴数
FROM table2 AS t12
INNER JOIN table1 AS t11
ON t12.max_views = t11.avg_views
AND t12.category = t11.category;
```

### output

```
+-----------------+--------------------+--------------------------------+
| カテゴリー      | 番組タイトル       | エピソード平均視聴数           |
+-----------------+--------------------+--------------------------------+
| ドラマ          | 半沢直樹           |                        2860000 |
| アニメ          | 進撃の巨人         |                        2480000 |
| バトル          | 進撃の巨人         |                        2480000 |
| スポーツ        | ハイキュー!!       |                        2272727 |
| オススメ        | ハイキュー!!       |                        2272727 |
+-----------------+--------------------+--------------------------------+
```